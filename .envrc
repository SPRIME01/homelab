# Auto-activate mise for the current shell
if command -v mise >/dev/null 2>&1; then
  if [ -n "$BASH_VERSION" ]; then
    eval "$(mise activate bash)"
  elif [ -n "$ZSH_VERSION" ]; then
    eval "$(mise activate zsh)"
  else
    # Fallback to POSIX sh activation
    eval "$(mise activate bash || true)"
  fi
fi

# Devbox availability shim (safe, non-destructive)
# Devbox is not auto-entered here. Run `devbox shell` manually when you want an interactive devbox.
if command -v devbox >/dev/null 2>&1; then
  export DEVBOX_AVAILABLE=1
  devbox-shell() {
    # Explicit interactive entry; does not run automatically on direnv load
    command devbox shell "$@"
  }
  alias devbox-shell=devbox-shell
fi

# Auto-detect homelab environment based on the presence of the SOPS/age key
# Do not override the variable if the user has explicitly set `HOMELAB`.
if [ -z "${HOMELAB-}" ]; then
  if [ -f "$HOME/.config/sops/age/keys.txt" ]; then
    export HOMELAB=1
  else
    export HOMELAB=0
  fi
fi

# Optional: auto-join Tailscale on shell load (commented-out by default).
# Auto-joining improves developer convenience but introduces a network dependency
# during shell startup. If you prefer automatic connectivity, uncomment the
# following lines. Otherwise run `just tailscale-join` manually when needed.
#
# if command -v just >/dev/null 2>&1; then
#   # Only auto-join when not in CI and when TAILSCALE_AUTHKEY is available
#   if [ -n "${HOMELAB-}" ] && [ "${HOMELAB:-0}" -eq 0 ]; then
#     # Dev machines: only attempt a lightweight connectivity step (no server)
#     true
#   else
#     # Homelab machines: consider auto-joining
#     # just tailscale-join || true
#     true
#   fi
# fi

# Configure Pulumi to use an XDG-style local file backend for state storage
# Append an XDG-friendly PULUMI_LOCAL_STATE and backend URL into infra/.envrc
echo 'export PULUMI_LOCAL_STATE="${PULUMI_LOCAL_STATE:-${XDG_STATE_HOME:-$HOME/.local/state}/pulumi}"' >> infra/.envrc
echo 'export PULUMI_BACKEND_URL="file://$PULUMI_LOCAL_STATE"' >> infra/.envrc
direnv allow infra/
